# FlyKylin 用户测试指南

## 🎯 当前版本功能

**Sprint 2 - Protobuf集成完成**

- ✅ UDP节点发现（P2P自动发现）
- ✅ **本地回环测试模式**（可以看到本机节点）
- ✅ Protobuf消息序列化（后端已集成）
- ✅ 用户列表显示
- ⏳ 聊天功能（Sprint 3-4 开发中）

## 🚀 快速开始

### 1. 启动程序

**方式一：使用已编译程序**
```powershell
cd build\windows-release\bin\Release
.\FlyKylin.exe
```

**方式二：重新编译运行**
```powershell
# 编译
cmake --build build/windows-release --config Release --target FlyKylin

# 运行
.\build\windows-release\bin\Release\FlyKylin.exe
```

### 2. 验证程序启动

启动后你应该看到：
- ✅ 窗口标题："FlyKylin P2P Chat - Sprint 1 Demo"
- ✅ 状态栏显示：`✓ 服务启动成功 | UDP端口: 45678 | TCP端口: 45679`
- ✅ 用户列表区域（初始为空）

**控制台输出示例**：
```
[PeerListViewModel] Created
[PeerListWidget] Created
[PeerDiscovery] Created
[PeerDiscovery] Listening on UDP port 45678
[MainWindow] Loopback mode enabled for development testing
[PeerDiscovery] Started successfully (TCP port: 45679)
[MainWindow] Services started successfully
```

## 🔬 本地回环测试

### 什么是本地回环模式？

Sprint 2 **新增功能**：允许程序发现自己，模拟多节点环境。

- 正常模式：程序会跳过本地地址，看不到自己
- **回环模式**：程序可以看到本机节点，用于开发测试

### 测试步骤

#### 步骤 1：观察本机节点

启动程序后，等待 **5-10 秒**，用户列表应该出现：
- **用户名**：你的计算机名（如 `DESKTOP-ABC123`）
- **IP地址**：本机IP（如 `127.0.0.1` 或局域网IP）
- **在线状态**：🟢 绿色圆点

**预期界面**：
```
┌──────────────────────────────┐
│  FlyKylin P2P聊天应用         │
├──────────────────────────────┤
│  在线用户 (1)                 │
│  ┌────────────────────────┐  │
│  │ 🟢 DESKTOP-ABC123      │  │
│  │    127.0.0.1:45679     │  │
│  └────────────────────────┘  │
├──────────────────────────────┤
│  ✓ 服务启动成功              │
│  UDP端口: 45678              │
│  TCP端口: 45679              │
└──────────────────────────────┘
```

#### 步骤 2：验证心跳机制

程序每 **5 秒** 发送一次心跳广播：
- 用户列表应该保持显示本机节点
- 控制台每 5 秒输出：`[PeerDiscovery] Sent broadcast (type: 3, size: X bytes)`

#### 步骤 3：测试节点离线

关闭程序后，**30 秒内** 重新启动，你会看到：
1. 旧节点仍在列表（等待超时）
2. 新节点出现（重新发现）
3. 30秒后旧节点自动移除

## 📊 控制台日志解读

### 正常启动日志

```
[PeerListViewModel] Created
[PeerListWidget] Created
[PeerDiscovery] Created
[PeerDiscovery] Listening on UDP port 45678
[MainWindow] Loopback mode enabled for development testing    ← 回环模式已启用
[PeerDiscovery] Sent broadcast (type: 1, size: 39 bytes)      ← 发送上线广播
[PeerDiscovery] Started successfully (TCP port: 45679)
[MainWindow] Services started successfully

# 5秒后...
[PeerDiscovery] Received from 127.0.0.1 type: 3 host: YOUR-PC tcp: 45679  ← 收到自己的心跳
[PeerDiscovery] New peer discovered: 127.0.0.1 YOUR-PC                    ← 发现本机节点
[PeerListViewModel] Peer discovered: 127.0.0.1
```

### 心跳日志（每5秒）

```
[PeerDiscovery] Sent broadcast (type: 3, size: 39 bytes)
[PeerDiscovery] Received from 127.0.0.1 type: 3 host: YOUR-PC tcp: 45679
```

## ❓ 常见问题

### Q1: 为什么看不到本机节点？

**可能原因**：
1. **防火墙阻止**：UDP 45678 端口被防火墙拦截
2. **端口占用**：其他程序占用了 45678 端口
3. **等待时间不够**：需要等待 5-10 秒让心跳触发

**解决方法**：
```powershell
# 检查端口占用
netstat -ano | findstr :45678

# 临时关闭 Windows 防火墙（测试用）
# 控制面板 → Windows Defender 防火墙 → 关闭防火墙
```

### Q2: 双击用户名没有反应？

这是**正常现象**！
- 当前版本（Sprint 2）只实现了节点发现
- 聊天功能在 **Sprint 3-4** 开发（TCP长连接 + 消息收发）

双击用户会弹出提示框：
```
功能提示
即将与用户 127.0.0.1 聊天
（US-002: TCP长连接功能开发中）
```

### Q3: 程序启动失败怎么办？

**错误提示**：`✗ 服务启动失败，请检查端口是否被占用`

**解决步骤**：
1. 检查其他 FlyKylin 实例是否在运行
2. 修改端口号（需要重新编译）：
   ```cpp
   // 在 MainWindow.h 中修改
   static constexpr quint16 kUdpPort = 45678;  // 改为其他端口如 45688
   static constexpr quint16 kTcpPort = 45679;  // 改为其他端口如 45689
   ```

## 🧪 高级测试

### 多实例测试（可选）

**注意**：当前版本由于端口冲突，同一台机器只能运行一个实例。

要测试多节点功能，你有两个选择：

**选项 A：修改端口号**
1. 复制一份代码
2. 修改第二份代码的端口号（如 45688/45689）
3. 编译第二个实例
4. 同时运行两个程序

**选项 B：使用虚拟机**
1. 在虚拟机中运行第二个实例
2. 确保虚拟机网络模式为"桥接"
3. 两个实例应该能互相发现

## 📝 测试检查清单

完成以下测试并打勾：

- [ ] 程序成功启动，状态栏显示绿色
- [ ] 5-10秒内用户列表出现本机节点
- [ ] 节点显示计算机名和IP地址
- [ ] 控制台每5秒输出心跳日志
- [ ] 双击用户弹出"功能开发中"提示
- [ ] 关闭程序，控制台输出 `[PeerDiscovery] Stopped`

## 🔮 后续版本预告

**Sprint 3-4（开发中）**：
- 📞 TCP长连接管理
- 💬 1v1文本聊天
- 📁 文件传输（带NSFW检测）
- 🤖 AI语义搜索

**如何关注进展**：
查看 `docs/sprints/active/` 目录下的 Sprint 计划文档

---

**问题反馈**：发现 Bug 或有建议？请在控制台复制完整日志并提交Issue
