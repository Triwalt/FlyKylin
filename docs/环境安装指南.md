# FlyKylin 环境安装指南

**最后更新**: 2024-11-18  
**当前状态**: Sprint 0 - 环境验证中

## 当前环境状态

### ✅ 已就绪
- Qt 6.9.3 MSVC 2022 64-bit - `D:\Qt\6.9.3\msvc2022_64`
- NSFW模型 - `E:\Project\tensorflow-open_nsfw\open_nsfw.onnx`
- BGE模型 - `E:\Project\tensorflow-open_nsfw\onnx_models\bge-small-zh-v1.5\`
- CMake 3.28.1

### ⚠️ 需要安装
1. ONNX Runtime C++ API 1.23.2
2. Protobuf compiler

## 安装步骤

### 步骤0: 验证当前环境

```powershell
.\tools\developer\verify-environment.ps1
```

### 步骤1: 下载ONNX Runtime

**方法A: 自动安装（推荐）**
```powershell
.\tools\developer\install-onnx-runtime.ps1
```

**方法B: 手动下载（如果网络问题）**

```
1. 浏览器打开:
   https://github.com/microsoft/onnxruntime/releases/tag/v1.23.2

2. 下载文件:
   onnxruntime-win-x64-1.23.2.zip (约30MB)

3. 解压到:
   e:\Project\FlyKylin\3rdparty\onnxruntime

4. 验证目录结构:
   e:\Project\FlyKylin\3rdparty\onnxruntime\
   ├── include\
   │   └── onnxruntime_c_api.h
   ├── lib\
   │   ├── onnxruntime.dll
   │   └── onnxruntime.lib
   └── LICENSE
```

### 步骤2: 安装Protobuf

**方法A: 自动安装（推荐）**
```powershell
# 需要管理员权限
.\tools\developer\install-protobuf.ps1
```

**方法B: 使用Chocolatey**
```powershell
# 管理员PowerShell
choco install protoc -y
```

**方法C: 使用vcpkg**
```powershell
.\vcpkg\vcpkg install protobuf:x64-windows
```

**方法D: 手动下载**
```
1. 下载: https://github.com/protocolbuffers/protobuf/releases
2. 解压并添加到PATH
```

### 步骤3: 验证环境

```powershell
.\tools\developer\verify-environment.ps1
```

预期输出:
```
[OK] Qt 6.9.3 MSVC 2022 64-bit
[OK] ONNX Runtime found
[OK] NSFW Model found
[OK] BGE Semantic Search Model found
[OK] Protobuf: libprotoc 3.x.x
[OK] CMake: cmake version 3.28.1
```

### 步骤4: 编译项目

在 **VS Developer Command Prompt for VS 2022** 中:

```cmd
cd e:\Project\FlyKylin

# 运行配置脚本(设置环境变量)
powershell .\configure-environment.ps1

# 创建build目录
mkdir build
cd build

# 配置CMake
cmake ..

# 编译Debug版本
cmake --build . --config Debug

# 如果成功，运行
.\bin\Debug\FlyKylin.exe
```

## 常见问题

### Q1: CMake找不到Qt6

**原因**: CMAKE_PREFIX_PATH未设置

**解决**:
```powershell
$env:CMAKE_PREFIX_PATH = "D:\Qt\6.9.3\msvc2022_64"
```

### Q2: ONNX Runtime链接错误

**原因**: 路径不正确或文件缺失

**检查**:
```powershell
dir e:\Project\FlyKylin\3rdparty\onnxruntime\lib\onnxruntime.lib
```

应该能看到文件。如果没有，重新解压。

### Q3: Protobuf not found

**原因**: protoc不在PATH中

**解决**:
```powershell
# 检查protoc
where.exe protoc

# 如果找不到，手动添加到PATH或使用Chocolatey安装
```

### Q4: 编译错误 - C2001

**原因**: 未在VS Developer Command Prompt中

**解决**: 必须在 "Developer Command Prompt for VS 2022" 中编译

### Q5: configure-environment.ps1显示乱码

**原因**: PowerShell编码问题

**解决**: 忽略乱码，只看结果状态([OK]/[WARN])

## 下一步

环境配置成功后：

1. 查看 `docs/requirements/Sprint_0_环境验证.md`
2. 完成ONNX Runtime测试程序
3. 验证NSFW模型加载
4. 进入Sprint 1开发

## 快速链接

- [FlyKylin需求](docs/requirements/FlyKylin需求.md) - 核心需求文档
- [Sprint 0计划](docs/requirements/Sprint_0_环境验证.md) - 当前Sprint
- [飞秋方案](docs/飞秋方案.md) - 详细技术方案
- [快速启动](快速启动.md) - 快速开始指南

## 技术栈摘要

| 组件 | 版本 | 路径/状态 |
|------|------|-----------|
| Qt | 6.9.3 MSVC 2022 | D:\Qt\6.9.3\msvc2022_64 ✅ |
| ONNX Runtime | 1.23.2 | 需下载 ⚠️ |
| Protobuf | latest | 需安装 ⚠️ |
| CMake | 3.28.1 | 已安装 ✅ |
| NSFW模型 | open_nsfw.onnx | E:\Project\tensorflow-open_nsfw ✅ |
| BGE模型 | bge-small-zh-v1.5 | E:\Project\tensorflow-open_nsfw ✅ |

---

**简化原则**: 不实现加密、认证、签名。专注于UDP+TCP通信和AI功能。
