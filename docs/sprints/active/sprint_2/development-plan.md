# Sprint 2 开发执行计划

**创建日期**: 2024-11-19  
**Sprint周期**: 2周（11-20 至 12-02）  
**总故事点**: 10 SP (US-002: 4 SP + US-004: 6 SP)  

---

## 📋 开发顺序

### 第一阶段：US-002 TCP连接管理器 (4 SP, 8天)

**目标**: 实现稳定的TCP长连接管理，支持智能重试、心跳保活和优先级队列

#### 里程碑计划

| 里程碑 | 时间 | 任务 | 交付物 | Code Review |
|--------|------|------|--------|-------------|
| **M1** | Day 1-2 | TcpConnection基础类 | 连接建立/断开、状态机 | ✅ 必需 |
| **M2** | Day 3-4 | 重试和心跳机制 | 指数退避、心跳保活 | ✅ 必需 |
| **M3** | Day 5-6 | 连接池和消息队列 | TcpConnectionManager、优先级队列 | ✅ 必需 |
| **M4** | Day 7 | 单元测试 | 覆盖率≥80% | ✅ 必需 |
| **M5** | Day 8 | 集成测试 | 双节点对发、性能测试 | ✅ 必需 |

---

### 第二阶段：US-004 文本消息与聊天窗口 (6 SP, 8天)

**目标**: 实现类似QQ的聊天窗口，支持消息收发、ACK确认和系统通知

#### 里程碑计划

| 里程碑 | 时间 | 任务 | 交付物 | Code Review |
|--------|------|------|--------|-------------|
| **M1** | Day 9-10 | ChatWindow UI | UI布局、输入框、消息显示 | ✅ 必需 |
| **M2** | Day 11-12 | 消息收发功能 | Protobuf序列化、TCP集成 | ✅ 必需 |
| **M3** | Day 13 | ACK和状态管理 | MessageStatusTracker | ✅ 必需 |
| **M4** | Day 14-15 | 通知功能 | Toast通知、托盘图标 | ✅ 必需 |
| **M5** | Day 16 | 集成测试 | 端到端聊天测试 | ✅ 必需 |

---

## 🔍 Code Review流程

### 每个里程碑的Review清单

**提交前检查**:
- [ ] 编译无警告（`/W4` MSVC或`-Wall -Wextra` GCC）
- [ ] 通过clang-format格式化（`.clang-format`配置）
- [ ] 单元测试覆盖率 ≥80%
- [ ] 添加Doxygen文档注释
- [ ] 无内存泄漏（Windows: 调试堆，Linux: Valgrind）

**Code Review要点**:
1. **功能正确性**: 是否符合验收标准
2. **架构一致性**: 是否遵循Tech Spec设计
3. **编码规范**: 是否符合`.windsurf/rules/coding-standards.md`
4. **线程安全**: 多线程访问是否正确加锁
5. **错误处理**: 异常场景是否处理完善
6. **性能**: 是否有明显性能问题

**Review通过标准**:
- ✅ 所有检查项通过
- ✅ 至少1人审核通过
- ✅ 无Critical级别问题

---

## 🧪 测试覆盖率要求

### 单元测试 (≥80%覆盖率)

**US-002测试范围**:
- `TcpConnection`: 状态转换、连接/断开、心跳
- `TcpConnectionManager`: 连接池管理、上限控制
- `MessageQueue`: 优先级排序、去重
- `RetryStrategy`: 指数退避算法

**US-004测试范围**:
- `ChatWindow`: 消息显示、输入验证
- `ChatWindowManager`: 窗口管理
- `SystemNotifier`: 通知触发
- `MessageStatusTracker`: ACK超时、重试

### 集成测试

**US-002**:
- 双节点TCP对发消息
- 网络断开自动重连
- 20个并发连接稳定性
- 消息队列优先级验证

**US-004**:
- 端到端聊天场景
- 离线消息处理
- 多窗口并发
- Toast通知触发

### 性能测试

**指标验证**:
- TCP连接建立时间 <50ms
- 消息发送延迟 <100ms
- 内存占用：20连接<100KB，10窗口<50MB
- CPU占用 <2%

---

## 🎨 UI实现方案

### ChatWindow UI

**决策**: 按Tech Spec直接实现，暂不需要UI设计师审查

**理由**:
1. Tech Spec已提供详细UI布局
2. 聊天窗口UI相对标准（类似QQ/微信）
3. Sprint Review时收集用户反馈，Sprint 3迭代优化

**实现规范**:
```
+------------------------------------------+
| [用户名]                      [连接状态] |
+------------------------------------------+
|  [聊天记录 - QTextEdit]                  |
|  [对方]: 消息内容 [10:30:15]             |
|  [我]: 消息内容 [10:31:20] ✓            |
+------------------------------------------+
| [输入框 - QLineEdit]         [发送按钮]  |
+------------------------------------------+
| 状态栏: 已连接 / 正在连接... / 连接失败   |
+------------------------------------------+
```

**后续优化**:
- Sprint 3: 美化样式表（QSS）
- Sprint 4: 表情包支持
- Sprint 5: 消息气泡UI

---

## 🔔 通知方案确认

### ✅ 测试结果：Toast通知不可行

**测试日期**: 2024-11-19  
**测试环境**: Windows 11  
**结论**: Windows Toast API在未签名应用中不可用

### 📌 最终方案：QSystemTrayIcon托盘通知

**实现方式**：
```cpp
void SystemNotifier::showNotification(const QString& title, const QString& message) {
    // 托盘气泡通知（跨平台通用）
    if (m_trayIcon) {
        m_trayIcon->showMessage(title, message, QSystemTrayIcon::Information, 3000);
    }
    
    // 托盘图标闪烁（吸引注意）
    flashTrayIcon(3);
    
    // 播放提示音（可选）
    playNotificationSound();
}
```

**优势**：
- ✅ Qt原生支持，无需Windows API
- ✅ 跨平台兼容（Windows + Linux）
- ✅ 无权限限制
- ✅ 实现简单可靠

**用户体验**：
- 新消息到达：托盘图标闪烁3次 + 气泡提示 + 提示音
- 效果类似早期QQ/微信（足够满足需求）

---

## 📅 开发时间表

### Week 1 (11-20 至 11-26)

| 日期 | 任务 | 负责模块 | Review |
|------|------|----------|--------|
| 11-20 (Thu) | US-002 M1: TcpConnection基础 | TcpConnection.{h,cpp} | Day 2晚 |
| 11-21 (Fri) | US-002 M1: 状态机完成 | 状态转换逻辑 | Day 2晚 |
| 11-22 (Sat) | US-002 M2: 重试策略 | RetryStrategy | - |
| 11-23 (Sun) | US-002 M2: 心跳机制 | 心跳保活 | Day 4晚 |
| 11-24 (Mon) | US-002 M3: 连接池 | TcpConnectionManager | - |
| 11-25 (Tue) | US-002 M3: 消息队列 | MessageQueue | Day 6晚 |
| 11-26 (Wed) | US-002 M4: 单元测试 | GoogleTest | - |

### Week 2 (11-27 至 12-02)

| 日期 | 任务 | 负责模块 | Review |
|------|------|----------|--------|
| 11-27 (Thu) | US-002 M5: 集成测试 | 双节点测试 | Day 8晚 |
| 11-28 (Fri) | US-004 M1: ChatWindow UI | ChatWindow.ui | - |
| 11-29 (Sat) | US-004 M1: UI交互 | 输入框、按钮 | Day 10晚 |
| 11-30 (Sun) | US-004 M2: 消息发送 | 序列化、发送 | - |
| 12-01 (Mon) | US-004 M2: 消息接收 | 反序列化、显示 | Day 12晚 |
| 12-02 (Tue) | US-004 M3: ACK机制 | MessageStatusTracker | Day 13晚 |

### Week 3 (12-03 至 12-05, 缓冲时间)

| 日期 | 任务 | 负责模块 | Review |
|------|------|----------|--------|
| 12-03 (Wed) | US-004 M4: Toast通知 | SystemNotifier | - |
| 12-04 (Thu) | US-004 M4: 托盘图标 | 闪烁、菜单 | Day 15晚 |
| 12-05 (Fri) | US-004 M5: 集成测试 | 端到端测试 | Day 16晚 |

---

## 📊 进度跟踪

### 每日Stand-up

**时间**: 每天晚上22:00  
**内容**:
1. 今天完成了什么？
2. 遇到什么问题？
3. 明天计划做什么？

**更新文档**: `docs/sprints/active/sprint_2/notes.md`

### 燃尽图更新

每日更新`plan.md`中的燃尽图：
```markdown
| 日期 | 剩余SP | 理想剩余 | 实际进度 |
|------|--------|----------|----------|
| Day 0 (11-19) | 10 | 10 | Sprint开始 |
| Day 1 (11-20) | 9.5 | 9.3 | M1开发中 |
...
```

---

## 🚨 风险和缓解

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| Toast通知权限被禁 | 中 | 中 | 降级到托盘通知 |
| 网络测试环境不足 | 高 | 低 | 使用本地回环+虚拟机 |
| 测试覆盖率不达标 | 高 | 中 | 提前编写测试，TDD开发 |
| Code Review时间不足 | 中 | 中 | 每个里程碑预留0.5天Review |

---

## ✅ Definition of Done (DoD)

每个User Story完成的标准：

- [ ] 所有验收标准通过
- [ ] 单元测试覆盖率 ≥80%
- [ ] 集成测试通过
- [ ] Code Review通过
- [ ] 文档更新完成（API文档、用户手册）
- [ ] 无已知Critical/High优先级Bug
- [ ] 性能指标达标
- [ ] 双平台验证（Windows + RK3566模拟）

---

## 🎯 Sprint目标提醒

**核心目标**: 实现P2P即时通信MVP

**成功标准**:
1. 两个用户可以稳定建立TCP连接
2. 发送文本消息秒到达（<100ms延迟）
3. 聊天窗口体验流畅
4. 系统通知正常工作
5. 代码质量达标（80%测试覆盖率）

**Sprint Review演示**:
- 演示双节点聊天
- 演示网络断开自动重连
- 演示Toast通知效果
- 展示代码覆盖率报告

---

**创建人**: Development Execution Agent  
**批准人**: Sprint Planning Agent  
**最后更新**: 2024-11-19
