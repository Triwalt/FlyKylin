name: Build and Release

on:
  push:
    branches: [ main, develop, 'feature/**' ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.1.0)'
        required: false
        default: ''

# Cancel in-progress runs for same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  QT6_VERSION: '6.6.3'       # Windows uses Qt6
  CMAKE_VERSION: '3.27.0'
  VCPKG_COMMIT: '2ad7bd06128280e02bfe02361d8ffd7d465cfcf0'
  BUILD_TYPE: Release
  VCPKG_BUILD_TYPE: release

jobs:
  # ===========================================
  # Windows AMD64 Build (Qt6)
  # ===========================================
  build-windows-amd64:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup CMake and Ninja
      uses: lukka/get-cmake@latest

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
    
    - name: Install Qt6
      uses: jurplel/install-qt-action@v4
      with:
        version: ${{ env.QT6_VERSION }}
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        modules: 'qtnetworkauth'
        cache: true
    
    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/vcpkg/installed
          ${{ github.workspace }}/vcpkg/packages
        key: vcpkg-windows-x64-${{ env.VCPKG_COMMIT }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-windows-x64-${{ env.VCPKG_COMMIT }}-
          vcpkg-windows-x64-
    
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
    
    - name: Configure CMake
      run: |
        cmake --preset windows-release `
          -DQt6_DIR="$env:Qt6_DIR" `
          -DCMAKE_PREFIX_PATH="$env:QT_ROOT_DIR"
    
    - name: Build
      run: cmake --build --preset windows-release --parallel
    
    - name: Run tests
      run: |
        cd build/windows-release
        ctest -C ${{ env.BUILD_TYPE }} --output-on-failure
    
    - name: Package
      run: |
        $VERSION = "${{ github.event.inputs.version }}"
        if ([string]::IsNullOrEmpty($VERSION)) {
          $VERSION = "${{ github.ref_name }}".TrimStart('v')
        }
        
        $PACKAGE_NAME = "FlyKylin-v$VERSION-windows-amd64"
        $PACKAGE_DIR = "package/$PACKAGE_NAME"
        
        New-Item -ItemType Directory -Force -Path $PACKAGE_DIR
        Copy-Item "build/windows-release/bin/Release/FlyKylin.exe" -Destination "$PACKAGE_DIR/"
        
        # Deploy Qt dependencies
        & "$env:QT_ROOT_DIR/bin/windeployqt.exe" `
          --release --no-translations `
          "$PACKAGE_DIR/FlyKylin.exe"
        
        # Copy documentation
        Copy-Item "README.md" -Destination "$PACKAGE_DIR/"
        Copy-Item "LICENSE" -Destination "$PACKAGE_DIR/" -ErrorAction SilentlyContinue
        
        # Create archive
        Compress-Archive -Path "$PACKAGE_DIR/*" `
          -DestinationPath "package/$PACKAGE_NAME.zip" -Force
        
        # Calculate SHA256
        $hash = Get-FileHash "package/$PACKAGE_NAME.zip" -Algorithm SHA256
        $hash.Hash | Out-File -FilePath "package/$PACKAGE_NAME.zip.sha256" -Encoding ASCII
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: FlyKylin-windows-amd64
        path: package/*.zip*
        retention-days: 30

  # ===========================================
  # Linux AMD64 Build (Qt5)
  # ===========================================
  build-linux-amd64:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install Qt5 and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential cmake ninja-build pkg-config \
          autoconf autoconf-archive automake libtool \
          qtbase5-dev qtdeclarative5-dev qtquickcontrols2-5-dev \
          libqt5sql5-sqlite libqt5test5 qttools5-dev qttools5-dev-tools \
          libgl1-mesa-dev libglu1-mesa-dev \
          libxkbcommon-dev libxcb-xkb-dev libxcb-cursor-dev \
          libxcb-keysyms1-dev libxcb-icccm4-dev libxcb-image0-dev \
          libxcb-render-util0-dev libxcb-shape0-dev libxcb-xinerama0-dev \
          libfontconfig1-dev libfreetype6-dev \
          libdbus-1-dev libssl-dev \
          libprotobuf-dev protobuf-compiler \
          libgtest-dev libgmock-dev
    
    - name: Verify Qt5 installation
      run: |
        echo "Qt5 version: $(qmake --version)"
        echo "Qt5 path: $(qmake -query QT_INSTALL_PREFIX)"
        echo "Qt5 libs: $(qmake -query QT_INSTALL_LIBS)"
    
    - name: Configure CMake (using system packages)
      run: |
        cmake -B build/linux-amd64-release \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTS=ON \
          -DFLYKYLIN_FORCE_QT5=ON
    
    - name: Build
      run: cmake --build build/linux-amd64-release --parallel
    
    - name: Run tests
      run: |
        cd build/linux-amd64-release
        ctest --output-on-failure || true
    
    - name: Package
      run: |
        VERSION="${{ github.event.inputs.version }}"
        if [ -z "$VERSION" ]; then
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
        fi
        
        PACKAGE_NAME="FlyKylin-v${VERSION}-linux-amd64"
        PACKAGE_DIR="package/${PACKAGE_NAME}"
        
        mkdir -p "$PACKAGE_DIR"
        cp build/linux-amd64-release/bin/FlyKylin "$PACKAGE_DIR/"
        
        # Copy Qt5 libraries
        mkdir -p "$PACKAGE_DIR/lib"
        QT_LIB_DIR=$(qmake -query QT_INSTALL_LIBS)
        cp -P $QT_LIB_DIR/libQt5Core.so* "$PACKAGE_DIR/lib/" 2>/dev/null || true
        cp -P $QT_LIB_DIR/libQt5Gui.so* "$PACKAGE_DIR/lib/" 2>/dev/null || true
        cp -P $QT_LIB_DIR/libQt5Widgets.so* "$PACKAGE_DIR/lib/" 2>/dev/null || true
        cp -P $QT_LIB_DIR/libQt5Network.so* "$PACKAGE_DIR/lib/" 2>/dev/null || true
        cp -P $QT_LIB_DIR/libQt5Qml.so* "$PACKAGE_DIR/lib/" 2>/dev/null || true
        cp -P $QT_LIB_DIR/libQt5Quick.so* "$PACKAGE_DIR/lib/" 2>/dev/null || true
        cp -P $QT_LIB_DIR/libQt5QuickControls2.so* "$PACKAGE_DIR/lib/" 2>/dev/null || true
        cp -P $QT_LIB_DIR/libQt5Sql.so* "$PACKAGE_DIR/lib/" 2>/dev/null || true
        
        echo '#!/bin/bash' > "$PACKAGE_DIR/FlyKylin.sh"
        echo 'DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"' >> "$PACKAGE_DIR/FlyKylin.sh"
        echo 'export LD_LIBRARY_PATH="$DIR/lib:$LD_LIBRARY_PATH"' >> "$PACKAGE_DIR/FlyKylin.sh"
        echo 'exec "$DIR/FlyKylin" "$@"' >> "$PACKAGE_DIR/FlyKylin.sh"
        chmod +x "$PACKAGE_DIR/FlyKylin.sh"
        
        # Copy documentation
        cp README.md "$PACKAGE_DIR/"
        cp LICENSE "$PACKAGE_DIR/" 2>/dev/null || true
        
        # Create archive
        cd package
        tar -czf "${PACKAGE_NAME}.tar.gz" "${PACKAGE_NAME}"
        sha256sum "${PACKAGE_NAME}.tar.gz" > "${PACKAGE_NAME}.tar.gz.sha256"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: FlyKylin-linux-amd64
        path: package/*.tar.gz*
        retention-days: 30

  # ===========================================
  # Linux ARM64 Build (Qt5, RK3566 compatible)
  # ===========================================
  build-linux-arm64:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64
    
    - name: Build in ARM64 container with Qt5
      run: |
        docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          -e VERSION=${{ github.event.inputs.version }} \
          -e REF_NAME=${{ github.ref_name }} \
          ubuntu:22.04 bash -c '
            set -e
            export DEBIAN_FRONTEND=noninteractive
            
            echo "==== Installing Qt5 and dependencies ===="
            apt-get update
            apt-get install -y \
              build-essential cmake ninja-build git pkg-config \
              autoconf autoconf-archive automake libtool \
              qtbase5-dev qtdeclarative5-dev qtquickcontrols2-5-dev \
              libqt5sql5-sqlite libqt5test5 qttools5-dev qttools5-dev-tools \
              libgl1-mesa-dev libglu1-mesa-dev \
              libxkbcommon-dev libxcb-xkb-dev libxcb-cursor-dev \
              libxcb-keysyms1-dev libxcb-icccm4-dev libxcb-image0-dev \
              libxcb-render-util0-dev libxcb-shape0-dev libxcb-xinerama0-dev \
              libfontconfig1-dev libfreetype6-dev \
              libdbus-1-dev libssl-dev \
              libprotobuf-dev protobuf-compiler \
              libgtest-dev libgmock-dev \
              curl zip unzip tar ca-certificates

            # Fix git "dubious ownership" error when running as root in container
            git config --global --add safe.directory "*"
            
            echo "==== Qt5 version ===="
            qmake --version
            echo "Qt5 libs: $(qmake -query QT_INSTALL_LIBS)"
            
            echo "==== Building project ===="
            cd /workspace
            cmake -B build/linux-arm64-release \
              -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DBUILD_TESTS=ON \
              -DFLYKYLIN_FORCE_QT5=ON \
              -DFLYKYLIN_FORCE_RK3566=ON

            cmake --build build/linux-arm64-release --parallel 2
            
            echo "==== Running tests ===="
            cd /workspace/build/linux-arm64-release
            ctest --output-on-failure || true
            cd /workspace
            
            echo "==== Packaging ===="
            VERSION_TAG="${VERSION}"
            if [ -z "${VERSION_TAG}" ]; then
              VERSION_TAG="${REF_NAME}"
            fi
            VERSION_TAG="${VERSION_TAG#v}"
            
            PACKAGE_NAME="FlyKylin-v${VERSION_TAG}-linux-arm64"
            PACKAGE_DIR="/workspace/package/${PACKAGE_NAME}"
            
            mkdir -p "${PACKAGE_DIR}"
            cp build/linux-arm64-release/bin/FlyKylin "${PACKAGE_DIR}/"
            
            # Copy Qt5 libraries
            mkdir -p "${PACKAGE_DIR}/lib"
            QT_LIB_DIR=$(qmake -query QT_INSTALL_LIBS)
            cp -P ${QT_LIB_DIR}/libQt5Core.so* "${PACKAGE_DIR}/lib/" 2>/dev/null || true
            cp -P ${QT_LIB_DIR}/libQt5Gui.so* "${PACKAGE_DIR}/lib/" 2>/dev/null || true
            cp -P ${QT_LIB_DIR}/libQt5Widgets.so* "${PACKAGE_DIR}/lib/" 2>/dev/null || true
            cp -P ${QT_LIB_DIR}/libQt5Network.so* "${PACKAGE_DIR}/lib/" 2>/dev/null || true
            cp -P ${QT_LIB_DIR}/libQt5Qml.so* "${PACKAGE_DIR}/lib/" 2>/dev/null || true
            cp -P ${QT_LIB_DIR}/libQt5Quick.so* "${PACKAGE_DIR}/lib/" 2>/dev/null || true
            cp -P ${QT_LIB_DIR}/libQt5QuickControls2.so* "${PACKAGE_DIR}/lib/" 2>/dev/null || true
            cp -P ${QT_LIB_DIR}/libQt5Sql.so* "${PACKAGE_DIR}/lib/" 2>/dev/null || true
            
            echo "#!/bin/bash" > "${PACKAGE_DIR}/FlyKylin.sh"
            echo "DIR=\"\$(cd \"\$(dirname \"\${BASH_SOURCE[0]}\")\" && pwd)\"" >> "${PACKAGE_DIR}/FlyKylin.sh"
            echo "export LD_LIBRARY_PATH=\"\${DIR}/lib:\${LD_LIBRARY_PATH}\"" >> "${PACKAGE_DIR}/FlyKylin.sh"
            echo "exec \"\${DIR}/FlyKylin\" \"\$@\"" >> "${PACKAGE_DIR}/FlyKylin.sh"
            chmod +x "${PACKAGE_DIR}/FlyKylin.sh"
            
            cp README.md "${PACKAGE_DIR}/" || true
            cp LICENSE "${PACKAGE_DIR}/" || true
            
            cd /workspace/package
            tar -czf "${PACKAGE_NAME}.tar.gz" "${PACKAGE_NAME}"
            sha256sum "${PACKAGE_NAME}.tar.gz" > "${PACKAGE_NAME}.tar.gz.sha256"
            
            echo "==== Package created: ${PACKAGE_NAME}.tar.gz ===="
          '
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: FlyKylin-linux-arm64
        path: package/*.tar.gz*
        retention-days: 30

  # ===========================================
  # Create GitHub Release
  # ===========================================
  create-release:
    needs: [build-windows-amd64, build-linux-amd64, build-linux-arm64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        find artifacts -type f \( -name "*.zip" -o -name "*.tar.gz" -o -name "*.sha256" \) | \
          xargs -I {} cp {} release-assets/
        ls -lh release-assets/
    
    - name: Generate release notes
      run: |
        VERSION="${{ github.ref_name }}"
        
        cat > RELEASE_NOTES.md << RELEASE_EOF
        # FlyKylin ${VERSION} Release
        
        **Release Date**: $(date +%Y-%m-%d)
        
        ## ðŸŽ¯ Highlights
        
        - Cross-platform P2P communication
        - UDP node discovery
        - Modern Qt UI (Qt6 on Windows, Qt5 on Linux)
        
        ## ðŸ“¦ Downloads
        
        ### Windows (Qt6)
        - **AMD64 (x64)**: FlyKylin-${VERSION}-windows-amd64.zip
        
        ### Linux (Qt5)
        - **AMD64 (x64)**: FlyKylin-${VERSION}-linux-amd64.tar.gz
        - **ARM64 (RK3566)**: FlyKylin-${VERSION}-linux-arm64.tar.gz
        
        ## ðŸš€ System Requirements
        
        ### Windows
        - Windows 10/11 (AMD64)
        - 4GB RAM minimum
        
        ### Linux
        - Ubuntu 22.04+ or compatible
        - Qt5 runtime libraries
        - 4GB RAM minimum
        
        ## âœ… Verification
        
        Verify downloads using SHA256 checksums provided.
        
        ---
        
        **Full Changelog**: https://github.com/${{ github.repository }}/compare/v0.0.0...${VERSION}
        RELEASE_EOF
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: RELEASE_NOTES.md
        files: release-assets/*
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
